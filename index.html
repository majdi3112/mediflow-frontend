<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <title>Consultium Live Transcriptie</title>
  <!-- 1️⃣  Socket.IO-client -->
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>
<body class="p-4">
  <button id="btn">🎙️ Start</button>
  <pre id="live" style="white-space: pre-wrap; border:1px solid #ccc; padding:1rem; margin-top:1rem;"></pre>

  <script>
  // 🔧 —— pas hier je eigen wss-URL aan
  const WS_URL = "wss://c8a5-35-221-218-235.ngrok-free.app/socket.io";

  let socket = null;
  let recorder = null;

  document.getElementById("btn").onclick = () =>
    recorder ? stop() : start();

  async function start() {
    // 2️⃣  Connect met WebSocket-only (geen HTTP long-poll fall-back)
    socket = io(WS_URL, { transports: ["websocket"] });

    socket.on("connect",   () => console.log("🔌  Verbonden"));
    socket.on("status",    msg => console.log(msg));
    socket.on("partial",   txt => document.getElementById("live").textContent = txt);
    socket.on("soep",      txt => alert("SOEP klaar:\n\n" + txt));
    socket.on("disconnect",()  => console.log("❌  Verbinding verbroken"));

    socket.emit("start");

    // 3️⃣  Microfoon
    const stream   = await navigator.mediaDevices.getUserMedia({ audio: true });
    const mimeType = MediaRecorder.isTypeSupported("audio/webm;codecs=opus")
                    ? "audio/webm;codecs=opus" : "";

    recorder = new MediaRecorder(stream, { mimeType });

    // 4️⃣  Elke timeslice (1000 ms) → blob → ArrayBuffer → emit("chunk")
    recorder.ondataavailable = async e => {
      if (e.data && e.data.size > 0) {
        const ab = await e.data.arrayBuffer();
        socket.emit("chunk", ab);          //  binary!
      }
    };

    recorder.start(10000);  // 1 s slices (mag ook 3000 ms)
    document.getElementById("btn").textContent = "⏹️ Stop";
  }

  function stop() {
    recorder.stop();
    recorder = null;
    socket.emit("stop");
    document.getElementById("btn").textContent = "🎙️ Start";
  }
  </script>
</body>
</html>
