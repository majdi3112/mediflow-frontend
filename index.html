<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <title>Consultium Live Transcriptie</title>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>
<body style="padding:1rem">
  <button id="btn">🎙️ Start</button>
  <pre id="live" style="white-space: pre-wrap; border:1px solid #ccc; padding:1rem; margin-top:1rem;"></pre>

  <script>
    const BASE_URL = "https://3e29-35-203-170-67.ngrok-free.app";  // HTTPS-URL uit Colab

    let socket, recorder;

    async function start() {
      console.clear();
      console.log("▶️ Starting…");

      // 1) Open Socket.IO-verbinding
      socket = io(BASE_URL, {
        transports: ["websocket"],
        path: "/socket.io"
      });
      socket.on("connect",       ()  => console.log("🔌 verbonden"));
      socket.on("connect_error", err => console.error("❌ connect_error:", err));
      socket.on("status",        m   => console.log("status:", m));
      socket.on("partial",       txt => console.log("partial:", txt));
      socket.on("final",         txt => console.log("final:", txt));
      socket.on("soep",          s   => console.log("soep:", s));

      socket.emit("start");

      // 2) Vraag microfoon-stream
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      // Laat browser kiezen voor codec
      recorder = new MediaRecorder(stream);
      
      // 3) Debug: check dat data aankomt
      recorder.ondataavailable = e => {
        console.log("📦 dataavailable, size:", e.data.size);
        if (e.data.size > 0) {
          e.data.arrayBuffer().then(ab => {
            console.log("✉️ emit chunk", ab.byteLength);
            socket.emit("chunk", ab);
          });
        }
      };

      // 4) Start met 1 s timeslice
      recorder.start(1000);
      document.getElementById("btn").textContent = "⏹️ Stop";
    }

    function stop() {
      recorder.stop();
      socket.emit("stop");
      recorder = null;
      document.getElementById("btn").textContent = "🎙️ Start";
    }

    document.getElementById("btn").onclick = () =>
      recorder ? stop() : start();
  </script>
</body>
</html>
