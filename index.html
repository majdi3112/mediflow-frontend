<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mediflow UI</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Inter', sans-serif; background: #f8fafc; }
    .expanding-textarea {
      min-height: 160px;
      max-height: 640px;
      overflow-y: auto;
      resize: none;
      padding: 1rem 1rem 4rem;
    }
    .formatted-output { background: transparent; border: none; box-shadow: none; padding: 0; }
    .scrollable-box { max-height: 240px; overflow-y: auto; background: transparent; padding: 0; }
    .text-red { color: red; font-weight: bold; }
    .text-orange { color: orange; font-weight: bold; }
    .text-yellow { color: goldenrod; font-weight: bold; }
    .text-purple { color: purple; font-weight: bold; }
    .fade-in { opacity: 0; animation: fadeIn 0.5s ease-out forwards; }
    @keyframes fadeIn { to { opacity: 1; } }
    /* Force bullets vertical */
    .formatted-output ul { display: block; margin:0 0 .75rem 1.5rem; padding:0; }
    .formatted-output li { display:list-item; margin-bottom:.5rem; }
    .formatted-output ul ul { margin-left:1rem; margin-bottom:.5rem; }
  </style>
</head>
  
 <!-- HEADER / LOGO -->
  <header class="flex items-center justify-between px-6 py-4 bg-white shadow">
    <div class="flex items-center space-x-3">
      <img src="images/logo.png" alt="Mediflow Logo" class="h-8 w-auto object-contain">
    </div>
    <img src="images/user-profile.png"
         alt="User Profile"
         class="w-12 h-12 rounded-full border border-gray-300 object-contain">
  </header>

  <!-- Main Content -->
 <main class="flex-1 p-8 ml-48">
    
        <!-- Input Box -->
<div class="mt-8 bg-white p-6 rounded-3xl shadow-sm border border-gray-200 w-2/3 mx-auto">
  <div class="relative">
    <textarea id="text-input"
      placeholder="Hier typen..."
      class="w-full p-4 text-lg placeholder-gray-400 bg-transparent outline-none expanding-textarea">
    </textarea>
    <span id="settings-btn"
      class="absolute top-4 right-4 text-gray-400 text-xl cursor-pointer">⚙️</span>
  </div>
  <button id="whisper-btn"
    class="mt-4 px-4 py-2 bg-blue-100 text-blue-700 rounded-full shadow hover:bg-blue-200 transition inline-flex items-center">
    🎙️ Start Opname
  </button>
</div>
 
        <!-- Audio-upload veld + knop -->
<div class="mt-6 w-2/3 mx-auto flex items-center gap-4">
    <input type="file" id="audio-upload" accept="audio/*" class="flex-1 px-4 py-2 border border-gray-300 rounded">
    <button onclick="uploadAudioFile()" class="px-6 py-2 bg-blue-600 text-white rounded shadow hover:bg-blue-700">
        🎙️ Upload Audio & Genereer Transcriptie
    </button>
</div>

        <!-- Button -->
        <div class="mt-6 flex justify-center">
          <button id="generate-soep"
            class="px-8 py-3 bg-gray-200 text-gray-700 rounded-full shadow hover:bg-gray-300 font-medium">
            SOEP
          </button>
          </div>


<!-- SOEP Verslag Container -->
<div id="verslag-container" class="mt-8 w-2/3 space-y-6 hidden">
  <template id="section-template">
    <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-200 fade-in">
      <h3 class="text-xl font-semibold mb-4">LETTER</h3>
      <div class="relative">
        <div class="scrollable-box">
          <div class="formatted-output text-lg leading-relaxed"></div>
        </div>
        <button class="absolute bottom-4 right-4 px-2 py-1 bg-gray-100 text-gray-700 rounded-full shadow">📋</button>
      </div>
    </div>
  </template>

  <div id="s-box"></div>
  <div id="o-box"></div>
  <div id="e-box"></div>
  <div id="p-box"></div>
</div>
</main>
  
<script>
  // 1) bullets ↔ verticale lijst + kleurcodes
  function formatBullets(text) {
    // vervang streepjes door bullet-char
    const parts = text.replace(/-\s*/g,'• ').split('•').slice(1);
    let html = '<ul class="list-disc pl-6 mb-4">';
    parts.forEach(part => {
      let item = part.trim();
      // kleurcode-regels:
      item = item
        .replace(/🔴\s*(.+?)\s*🔴/g, '<span class="text-red">$1</span>')
        .replace(/🟠\s*(.+?)\s*🟠/g, '<span class="text-orange">$1</span>')
        .replace(/🟡\s*(.+?)\s*🟡/g, '<span class="text-yellow">$1</span>')
        .replace(/🟣\s*(.+?)\s*🟣/g, '<span class="text-purple">$1</span>');
      html += <li class="mb-2">${item}</li>;
    });
    html += '</ul>';
    return html;
  }

  // 2) bouw S/O/E/P-sectie dynamisch
  function createSection(letter, content) {
    const tmpl = document.getElementById('section-template');
    const clone = tmpl.content.cloneNode(true);
    clone.querySelector('h3').textContent = letter;
    clone.querySelector('.formatted-output').innerHTML = formatBullets(content);
    clone.querySelector('button').onclick = () => {
      navigator.clipboard.writeText(
        clone.querySelector('.formatted-output').innerText
      );
    };
    return clone;
  }

  // 3) SOEP-knop + fade-in + smooth scroll
  document.getElementById('generate-soep').addEventListener('click', async () => {
    const input = document.getElementById('text-input').value.trim();
    if (!input) return alert('Vul eerst een tekst in.');
    try {
      const res = await fetch('/generate-soep', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({prompt: input})
      });
      const data = await res.json();
      ['S','O','E','P'].forEach(letter => {
        const box = document.getElementById(letter.toLowerCase()+'-box');
        box.innerHTML = '';
        box.appendChild(createSection(letter, data[letter.toLowerCase()]));
      });
      const vc = document.getElementById('verslag-container');
      vc.classList.remove('hidden');
      vc.scrollIntoView({ behavior: 'smooth', block: 'start' });
    } catch(err) {
      console.error(err);
      alert('Serverfout');
    }
  });

  // 4) auto-expand textarea (max 640px, daarna scroll)
  document.querySelectorAll('.expanding-textarea').forEach(textarea => {
    const max = 640;
    function adjust() {
      textarea.style.height = 'auto';
      const h = Math.min(textarea.scrollHeight, max);
      textarea.style.height = h + 'px';
      textarea.style.overflowY = textarea.scrollHeight > max ? 'auto' : 'hidden';
    }
    textarea.addEventListener('input', adjust);
    textarea.addEventListener('paste', () => setTimeout(adjust, 0));
    adjust();
  });
</script>
<script>
    // 📤 Upload audio naar backend (bijvoorbeeld na opnemen)
    async function uploadAudio(file) {
        const formData = new FormData();
        formData.append("file", file);

        try {
            const response = await fetch("https://8b24-35-227-109-177.ngrok-free.app//transcribe-audio", {
                method: "POST",
                body: formData
            });

            const result = await response.json();

            if (result.error) {
                alert("Fout bij transcriptie: " + result.error);
            } else {
                // ✅ Toon alleen de VERBETERDE transcriptie
                document.getElementById("text-input").value = result.transcription;
            }
        } catch (error) {
            console.error("Fout bij upload:", error);
            alert("Kon geen verbinding maken met de backend.");
        }
    }
    async function uploadAudioFile() {
        const fileInput = document.getElementById('audio-upload');
        const file = fileInput.files[0];

        if (!file) {
            alert("📂 Kies een audiobestand om te uploaden.");
            return;
        }

        const formData = new FormData();
        formData.append("file", file);

        try {
            const response = await fetch("https://8b24-35-227-109-177.ngrok-free.app//transcribe-audio", {
                method: "POST",
                body: formData
            });

            const result = await response.json();

            if (result.error) {
                alert("❌ Fout bij transcriptie: " + result.error);
            } else {
                document.getElementById("text-input").value = result.transcription;
            }
        } catch (error) {
            console.error("❌ Uploadfout:", error);
            alert("Er ging iets mis bij het uploaden.");
        }
    }

let whisperRecorder = null;
let whisperStream = null;
let whisperChunks = [];
let isRecording = false;

document.getElementById("whisper-btn").addEventListener("click", async function () {
    const button = this;

    if (!isRecording) {
        try {
            // Start opname
            whisperStream = await navigator.mediaDevices.getUserMedia({ audio: true });

            // Check voor browser support mime type
            const options = MediaRecorder.isTypeSupported("audio/webm")
                ? { mimeType: "audio/webm" }
                : { mimeType: "audio/webm;codecs=opus" };

            whisperRecorder = new MediaRecorder(whisperStream, options);
            whisperChunks = [];

            whisperRecorder.ondataavailable = function (e) {
                if (e.data.size > 0) {
                    whisperChunks.push(e.data);
                }
            };

            whisperRecorder.onstop = async function () {
                const audioBlob = new Blob(whisperChunks, { type: "audio/webm" });
                const formData = new FormData();
                formData.append("file", audioBlob, "recording.webm");

                try {
                    const response = await fetch("https://8b24-35-227-109-177.ngrok-free.app//transcribe-audio", {
                        method: "POST",
                        body: formData
                    });

                    const result = await response.json();
                    if (result.error) {
                        alert("❌ Fout bij transcriptie: " + result.error);
                    } else {
                        document.getElementById("text-input").value = result.transcription;
                    }
                } catch (err) {
                    console.error("❌ Fout bij uploaden:", err);
                    alert("❌ Kon transcriptie niet ophalen.");
                }

                whisperStream.getTracks().forEach(track => track.stop());
                whisperRecorder = null;
                isRecording = false;

                button.textContent = "🎙️ Start Opname";
                button.classList.remove("bg-red-500");
                button.classList.add("bg-blue-200");
            };

            whisperRecorder.start();
            isRecording = true;
            button.textContent = "⏹️ Stop";
            button.classList.remove("bg-blue-200");
            button.classList.add("bg-red-500");

        } catch (err) {
            console.error("🎤 Microfoonfout:", err);
            alert("❌ Kon microfoon niet starten.");
        }
    } else {
        // Stop opname
        if (whisperRecorder && whisperRecorder.state === "recording") {
            whisperRecorder.stop(); // ⬅️ dit triggert .onstop()
        }
    }
});

</script>
 <!-- AI assistant chatbox-->
 <div class="mt-8 bg-white p-4 rounded-lg shadow-lg flex flex-col border border-gray-200 relative w-2/3 mx-auto">
    <div id="chat-messages" class="mb-4 max-h-60 overflow-y-auto space-y-2"></div>
    <textarea id="chat-input" placeholder="Stel je vraag..." class="w-full p-3 outline-none text-lg border-none expanding-textarea"></textarea>
    <button id="chat-send" class="ml-2 mt-2 px-4 py-2 bg-blue-600 text-white rounded">Verzenden</button>
 </div>


<script>
    document.getElementById("chat-send").addEventListener("click", async function() {
      const inputField = document.getElementById("chat-input");
      const chatMessages = document.getElementById("chat-messages");
      const message = inputField.value.trim();
      if (!message) return;
  
      // Toon de vraag van de gebruiker in de chatbox
      const userMessageElem = document.createElement("div");
      userMessageElem.textContent = "Jij: " + message;
      userMessageElem.classList.add("text-right", "font-medium");
      chatMessages.appendChild(userMessageElem);
  
      // Maak de input leeg
      inputField.value = "";
  
      try {
        // Pas de URL hieronder aan naar jouw ngrok-domein of backend URL
        const response = await fetch("https://8b24-35-227-109-177.ngrok-free.app//chat-assistant", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ message: message })
        });
        const result = await response.json();
  
        if (result.error) {
          alert("Fout: " + result.error);
        } else {
          const botMessageElem = document.createElement("div");
          botMessageElem.textContent = "Assistent: " + result.reply;
          botMessageElem.classList.add("text-left", "italic");
          chatMessages.appendChild(botMessageElem);
        }
      } catch (error) {
        console.error("Fout bij chatbericht:", error);
        alert("Er is een probleem met de server.");
      }
    });
  </script>
 </body> 
</html>
